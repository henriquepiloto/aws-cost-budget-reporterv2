<!DOCTYPE html>
<html>
<head>
    <title>Prisma - Administra√ß√£o Cloudinho</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style id="dynamicStyles">
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-color: #2c3e50;
            --app-name: 'Cloudinho';
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        .login-container { 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .login-box { 
            background: white; padding: 40px; border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 400px;
        }
        .login-box h1 { text-align: center; margin-bottom: 30px; color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 5px; font-size: 16px;
        }
        .btn { 
            padding: 12px 20px; background: var(--primary-color); color: white; 
            border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-right: 10px;
        }
        .btn:hover { filter: brightness(0.9); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        
        .main-container { display: none; height: 100vh; }
        .sidebar { 
            width: 300px; background: var(--sidebar-color); color: white; 
            padding: 20px; overflow-y: auto;
        }
        .sidebar h2 { margin-bottom: 20px; }
        .sidebar .user-info { 
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px;
        }
        .sidebar .menu-item { 
            padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); 
            border-radius: 5px; cursor: pointer;
        }
        .sidebar .menu-item:hover { background: rgba(255,255,255,0.2); }
        .sidebar .menu-item.active { background: var(--primary-color); }
        
        .main-content { 
            flex: 1; display: flex; flex-direction: column; 
            background: white;
        }
        .header { 
            background: white; padding: 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .chat-container { 
            display: flex; flex-direction: column; height: 100%;
        }
        .chat-messages { 
            flex: 1; border: 1px solid #ddd; border-radius: 5px; 
            padding: 20px; overflow-y: auto; margin-bottom: 20px;
            background: #fafafa;
        }
        .message { 
            margin-bottom: 15px; padding: 10px; border-radius: 10px;
        }
        .message.user { 
            background: var(--primary-color); color: white; margin-left: 20%; text-align: right;
        }
        .message.bot { 
            background: #e9ecef; color: #333; margin-right: 20%;
        }
        .message.system { 
            background: #d4edda; color: #155724; text-align: center;
            font-style: italic;
        }
        
        .chat-input { 
            display: flex; gap: 10px;
        }
        .chat-input input { 
            flex: 1; padding: 12px; border: 1px solid #ddd; 
            border-radius: 5px; font-size: 16px;
        }
        
        .config-section { 
            background: white; padding: 20px; border-radius: 5px; 
            margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .config-section h3 { margin-bottom: 15px; color: #333; }
        
        .users-table { 
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .users-table th, .users-table td { 
            padding: 12px; text-align: left; border-bottom: 1px solid #ddd;
        }
        .users-table th { background: #f8f9fa; font-weight: 600; }
        .users-table tr:hover { background: #f8f9fa; }
        
        .status-active { color: #28a745; font-weight: bold; }
        .status-blocked { color: #dc3545; font-weight: bold; }
        
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        }
        .modal-content { 
            background: white; margin: 5% auto; padding: 20px; 
            border-radius: 10px; width: 80%; max-width: 500px;
        }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px;
        }
        .close { 
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        
        .color-picker { 
            display: flex; align-items: center; gap: 10px;
        }
        .color-preview { 
            width: 30px; height: 30px; border-radius: 5px; border: 1px solid #ddd;
        }
        
        .logo-preview { 
            max-width: 200px; max-height: 100px; border: 1px solid #ddd; 
            border-radius: 5px; margin-top: 10px;
        }
        
        .hidden { display: none !important; }
        .error { color: #dc3545; margin: 10px 0; }
        .success { color: #28a745; margin: 10px 0; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="loginLogo" src="" alt="" style="max-height: 60px; display: none;">
                <h1 id="loginTitle">üîê Prisma Admin</h1>
            </div>
            <p style="text-align: center; margin-bottom: 30px; color: #666;">
                Administra√ß√£o do <span id="appNameLogin">Cloudinho</span>
            </p>
            
            <div id="loginForm">
                <div id="loginError" class="error hidden"></div>
                <div class="form-group">
                    <label>Usu√°rio</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha">
                </div>
                <button class="btn" onclick="login()" style="width: 100%;">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container" style="display: flex;">
        <div class="sidebar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <img id="sidebarLogo" src="" alt="" style="max-height: 40px; display: none;">
                <h2 id="sidebarTitle">üîê Prisma</h2>
            </div>
            <div class="user-info">
                <div><strong id="currentUser">Usu√°rio</strong></div>
                <div><small id="userRole">Role</small></div>
            </div>
            
            <div class="menu-item active" onclick="showSection('chat')">
                üí¨ Chat
            </div>
            <div class="menu-item" onclick="showSection('users')">
                üë• Usu√°rios
            </div>
            <div class="menu-item" onclick="showSection('config')">
                ‚öôÔ∏è Configura√ß√µes
            </div>
            <div class="menu-item" onclick="showSection('visual')">
                üé® Apar√™ncia
            </div>
            <div class="menu-item" onclick="showSection('admin')">
                üëë Sistema
            </div>
            <div class="menu-item" onclick="logout()">
                üö™ Sair
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Chat com IA</h1>
                <div>
                    <span id="headerUser"></span>
                </div>
            </div>
            
            <div class="content">
                <!-- Chat Section -->
                <div id="chatSection" class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            Bem-vindo ao <span id="appNameChat">Cloudinho</span>! Como posso ajudar voc√™ hoje?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Digite sua mensagem..." 
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn" onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div id="usersSection" class="hidden">
                    <div class="config-section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Gerenciamento de Usu√°rios</h3>
                            <button class="btn btn-success" onclick="showCreateUserModal()">+ Novo Usu√°rio</button>
                        </div>
                        
                        <table class="users-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usu√°rio</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Criado</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="7">Carregando usu√°rios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Config Section -->
                <div id="configSection" class="hidden">
                    <div class="config-section">
                        <h3>Configura√ß√µes do Chat</h3>
                        <div class="form-group">
                            <label>Modelo de IA</label>
                            <select id="aiModel" onchange="saveConfig()">
                                <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="claude-3-haiku">Claude 3 Haiku</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Temperatura (Criatividade)</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" onchange="saveConfig()">
                            <span id="tempValue">0.7</span>
                        </div>
                        <div class="form-group">
                            <label>M√°ximo de Tokens</label>
                            <input type="number" id="maxTokens" value="1000" onchange="saveConfig()">
                        </div>
                    </div>
                </div>
                
                                <!-- Visual Config Section -->
                <div id="visualSection" class="hidden">
                    <div class="config-section">
                        <h3>Configura√ß√µes de Apar√™ncia</h3>
                        <div id="visualSuccess" class="success hidden"></div>
                        <div id="visualError" class="error hidden"></div>
                        
                        <div class="form-group">
                            <label>Nome da Aplica√ß√£o</label>
                            <input type="text" id="appName" placeholder="Cloudinho">
                        </div>
                        
                        <div class="form-group">
                            <label>URL do Logo</label>
                            <input type="url" id="logoUrl" placeholder="https://exemplo.com/logo.png">
                            <img id="logoPreview" class="logo-preview hidden" alt="Preview do logo">
                        </div>
                        
                        <div class="form-group">
                            <label>Cor Prim√°ria</label>
                            <div class="color-picker">
                                <input type="color" id="primaryColor" value="#667eea">
                                <div class="color-preview" id="primaryPreview"></div>
                                <span id="primaryColorValue">#667eea</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Cor Secund√°ria</label>
                            <div class="color-picker">
                                <input type="color" id="secondaryColor" value="#764ba2">
                                <div class="color-preview" id="secondaryPreview"></div>
                                <span id="secondaryColorValue">#764ba2</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Cor do Menu Lateral</label>
                            <div class="color-picker">
                                <input type="color" id="sidebarColor" value="#2c3e50">
                                <div class="color-preview" id="sidebarPreview"></div>
                                <span id="sidebarColorValue">#2c3e50</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="saveVisualConfig()">üíæ Salvar Altera√ß√µes</button>
                            <button class="btn btn-secondary" onclick="resetVisualConfig()">üîÑ Restaurar Padr√£o</button>
                        </div>
                    </div>
                </div>
                        
                        <div class="form-group">
                            <label>Cor Secund√°ria</label>
                            <div class="color-picker">
                                <input type="color" id="secondaryColor" value="#764ba2" onchange="saveVisualConfig()">
                                <div class="color-preview" id="secondaryPreview"></div>
                                <span id="secondaryColorValue">#764ba2</span>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="resetVisualConfig()">Restaurar Padr√£o</button>
                    </div>
                </div>
                
                <!-- Admin Section -->
                <div id="adminSection" class="hidden">
                    <div class="config-section">
                        <h3>Status do Sistema</h3>
                        <p>‚úÖ Sistema de Autentica√ß√£o: Ativo</p>
                        <p>‚úÖ Conex√£o com Bedrock: Ativo</p>
                        <p>‚úÖ Banco de Dados: Conectado</p>
                        <p>‚úÖ API Gateway: Funcionando</p>
                        <p>‚úÖ Dom√≠nio: prisma.selectsolucoes.com</p>
                        
                        <h4 style="margin-top: 20px;">Estat√≠sticas</h4>
                        <p>Usu√°rios totais: <span id="totalUsers">-</span></p>
                        <p>Usu√°rios ativos: <span id="activeUsers">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Usu√°rio</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div id="modalError" class="error hidden"></div>
            <div id="modalSuccess" class="success hidden"></div>
            
            <div class="form-group">
                <label>Usu√°rio *</label>
                <input type="text" id="modalUsername" placeholder="Nome de usu√°rio" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="modalEmail" placeholder="email@exemplo.com">
            </div>
            <div class="form-group">
                <label>Senha *</label>
                <input type="password" id="modalPassword" placeholder="Nova senha" required>
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="modalRole">
                    <option value="user">Usu√°rio</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="modalStatus">
                    <option value="active">Ativo</option>
                    <option value="blocked">Bloqueado</option>
                </select>
            </div>
            <div class="form-group">
                <label>Permiss√µes</label>
                <select id="modalPermissions">
                    <option value="chat">Chat</option>
                    <option value="chat,config">Chat + Config</option>
                    <option value="all">Todas</option>
                </select>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveUser()">Salvar</button>
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        const API_URL = 'https://m153no51s0.execute-api.us-east-1.amazonaws.com/prod';
        let currentUser = null;
        let currentConfig = {};
        let editingUserId = null;
        let visualConfig = {};

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function showSuccess(elementId, message) {
            const successEl = document.getElementById(elementId);
            successEl.textContent = message;
            successEl.classList.remove('hidden');
            setTimeout(() => successEl.classList.add('hidden'), 3000);
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            loadConfig();
            loadUsers();
            loadVisualConfig();
        }

        function showSection(section) {
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('visualSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(section + 'Section').classList.remove('hidden');
            event.target.classList.add('active');
            
            const titles = {
                'chat': 'Chat com IA',
                'users': 'Gerenciamento de Usu√°rios',
                'config': 'Configura√ß√µes',
                'visual': 'Configura√ß√µes de Apar√™ncia',
                'admin': 'Status do Sistema'
            };
            document.getElementById('pageTitle').textContent = titles[section];
            
            if (section === 'users') {
                loadUsers();
            } else if (section === 'visual') {
                loadVisualConfig();
            }
        }

        async function makeRequest(url, data, method = 'POST') {
            const options = {
                method: method,
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' }
            };
            
            if (data) options.body = JSON.stringify(data);
            
            const token = localStorage.getItem('token');
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url, options);
            
            let responseData;
            try {
                responseData = await response.json();
            } catch (e) {
                responseData = { error: 'Invalid response format' };
            }
            
            if (!response.ok) {
                throw new Error(responseData.error || `HTTP error! status: ${response.status}`);
            }
            
            return responseData;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showError('loginError', 'Por favor, digite usu√°rio e senha');
                return;
            }

            try {
                const data = await makeRequest(`${API_URL}/login`, {username, password});
                
                if (data.role !== 'admin') {
                    showError('loginError', 'Acesso negado. Apenas administradores.');
                    return;
                }
                
                localStorage.setItem('token', data.token);
                currentUser = {username, role: data.role};
                
                document.getElementById('currentUser').textContent = username;
                document.getElementById('userRole').textContent = data.role;
                document.getElementById('headerUser').textContent = username;
                
                showMainApp();
                
            } catch (error) {
                showError('loginError', 'Login falhou. Verifique suas credenciais.');
            }
        }

        async function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message.trim()) return;

            const messagesContainer = document.getElementById('chatMessages');
            
            messagesContainer.innerHTML += `
                <div class="message user">
                    <strong>Voc√™:</strong> ${message}
                </div>
            `;
            
            document.getElementById('messageInput').value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const data = await makeRequest(`${API_URL}/chat`, {message});
                
                messagesContainer.innerHTML += `
                    <div class="message bot">
                        <strong>${visualConfig.app_name || 'Cloudinho'}:</strong> ${data.response}
                    </div>
                `;
                
            } catch (error) {
                messagesContainer.innerHTML += `
                    <div class="message bot">
                        <strong>${visualConfig.app_name || 'Cloudinho'}:</strong> Desculpe, estou com problemas t√©cnicos no momento.
                    </div>
                `;
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function loadUsers() {
            try {
                const users = await makeRequest(`${API_URL}/users`, null, 'GET');
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.role}</td>
                        <td><span class="status-${user.status || 'active'}">${user.status || 'active'}</span></td>
                        <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
                        <td>
                            <button class="btn" onclick="editUser(${user.id})">Editar</button>
                            <button class="btn btn-secondary" onclick="resetUserPassword(${user.id})">Reset Senha</button>
                            <button class="btn ${(user.status || 'active') === 'active' ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleUserStatus(${user.id}, '${user.status || 'active'}')">
                                ${(user.status || 'active') === 'active' ? 'Bloquear' : 'Ativar'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})">Deletar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('activeUsers').textContent = users.filter(u => (u.status || 'active') === 'active').length;
                
            } catch (error) {
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7">Erro ao carregar usu√°rios</td></tr>';
            }
        }

        function showCreateUserModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalEmail').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalRole').value = 'user';
            document.getElementById('modalStatus').value = 'active';
            document.getElementById('modalPermissions').value = 'chat';
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalSuccess').classList.add('hidden');
            document.getElementById('userModal').style.display = 'block';
        }

        async function editUser(userId) {
            try {
                const users = await makeRequest(`${API_URL}/users`, null, 'GET');
                const user = users.find(u => u.id === userId);
                
                if (user) {
                    editingUserId = userId;
                    document.getElementById('modalTitle').textContent = 'Editar Usu√°rio';
                    document.getElementById('modalUsername').value = user.username;
                    document.getElementById('modalEmail').value = user.email || '';
                    document.getElementById('modalPassword').value = '';
                    document.getElementById('modalRole').value = user.role;
                    document.getElementById('modalStatus').value = user.status || 'active';
                    document.getElementById('modalPermissions').value = user.permissions || 'chat';
                    document.getElementById('modalError').classList.add('hidden');
                    document.getElementById('modalSuccess').classList.add('hidden');
                    document.getElementById('userModal').style.display = 'block';
                }
            } catch (error) {
                alert('Erro ao carregar dados do usu√°rio');
            }
        }

        async function saveUser() {
            const username = document.getElementById('modalUsername').value.trim();
            const password = document.getElementById('modalPassword').value.trim();
            const email = document.getElementById('modalEmail').value.trim();
            
            if (!username) {
                showError('modalError', 'Nome de usu√°rio √© obrigat√≥rio');
                return;
            }
            
            if (!editingUserId && !password) {
                showError('modalError', 'Senha √© obrigat√≥ria para novos usu√°rios');
                return;
            }
            
            const userData = {
                username: username,
                email: email || null,
                role: document.getElementById('modalRole').value,
                status: document.getElementById('modalStatus').value,
                permissions: document.getElementById('modalPermissions').value
            };
            
            if (password) {
                userData.password = password;
            }
            
            try {
                if (editingUserId) {
                    userData.id = editingUserId;
                    await makeRequest(`${API_URL}/users`, userData, 'PUT');
                    showSuccess('modalSuccess', 'Usu√°rio atualizado com sucesso!');
                } else {
                    await makeRequest(`${API_URL}/users`, userData, 'POST');
                    showSuccess('modalSuccess', 'Usu√°rio criado com sucesso!');
                }
                
                setTimeout(() => {
                    closeUserModal();
                    loadUsers();
                }, 1500);
                
            } catch (error) {
                console.error('Save user error:', error);
                showError('modalError', error.message || 'Erro ao salvar usu√°rio. Verifique os dados.');
            }
        }

        async function resetUserPassword(userId) {
            if (confirm('Resetar senha do usu√°rio para "temp123"?')) {
                try {
                    await makeRequest(`${API_URL}/users`, {id: userId, password: 'temp123'}, 'PUT');
                    alert('Senha resetada para: temp123');
                } catch (error) {
                    alert('Erro ao resetar senha');
                }
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
            const action = newStatus === 'blocked' ? 'bloquear' : 'ativar';
            
            if (confirm(`Confirma ${action} este usu√°rio?`)) {
                try {
                    await makeRequest(`${API_URL}/users`, {id: userId, status: newStatus}, 'PUT');
                    loadUsers();
                } catch (error) {
                    alert('Erro ao alterar status do usu√°rio');
                }
            }
        }

        async function deleteUser(userId) {
            if (confirm('ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel. Deletar usu√°rio?')) {
                try {
                    await makeRequest(`${API_URL}/users?id=${userId}`, null, 'DELETE');
                    loadUsers();
                } catch (error) {
                    alert('Erro ao deletar usu√°rio');
                }
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalSuccess').classList.add('hidden');
        }

        async function loadConfig() {
            try {
                const config = await makeRequest(`${API_URL}/config`, null, 'GET');
                currentConfig = config;
                
                if (config.aiModel) document.getElementById('aiModel').value = config.aiModel;
                if (config.temperature) {
                    document.getElementById('temperature').value = config.temperature;
                    document.getElementById('tempValue').textContent = config.temperature;
                }
                if (config.maxTokens) document.getElementById('maxTokens').value = config.maxTokens;
                
            } catch (error) {
                console.log('No config found, using defaults');
            }
        }

        async function saveConfig() {
            const config = {
                aiModel: document.getElementById('aiModel').value,
                temperature: document.getElementById('temperature').value,
                maxTokens: document.getElementById('maxTokens').value
            };
            
            document.getElementById('tempValue').textContent = config.temperature;
            
            try {
                await makeRequest(`${API_URL}/config`, config);
                currentConfig = config;
            } catch (error) {
                console.error('Failed to save config:', error);
            }
        }

                async function loadVisualConfig() {
            try {
                console.log('Loading visual config...');
                const response = await fetch(API_URL + '/visual-config');
                
                if (response.ok) {
                    visualConfig = await response.json();
                    console.log('Visual config loaded:', visualConfig);
                } else {
                    visualConfig = {
                        app_name: 'Cloudinho',
                        logo_url: '',
                        primary_color: '#667eea',
                        secondary_color: '#764ba2',
                        sidebar_color: '#2c3e50'
                    };
                }
                
                // Update form fields if they exist
                const appNameField = document.getElementById('appName');
                const logoUrlField = document.getElementById('logoUrl');
                const primaryColorField = document.getElementById('primaryColor');
                const secondaryColorField = document.getElementById('secondaryColor');
                const sidebarColorField = document.getElementById('sidebarColor');
                
                if (appNameField) appNameField.value = visualConfig.app_name || 'Cloudinho';
                if (logoUrlField) logoUrlField.value = visualConfig.logo_url || '';
                if (primaryColorField) primaryColorField.value = visualConfig.primary_color || '#667eea';
                if (secondaryColorField) secondaryColorField.value = visualConfig.secondary_color || '#764ba2';
                if (sidebarColorField) sidebarColorField.value = visualConfig.sidebar_color || '#2c3e50';
                
                applyVisualConfig();
                updateColorPreviews();
                updateLogoPreview();
                
            } catch (error) {
                console.error('Failed to load visual config:', error);
                visualConfig = {
                    app_name: 'Cloudinho',
                    logo_url: '',
                    primary_color: '#667eea',
                    secondary_color: '#764ba2',
                    sidebar_color: '#2c3e50'
                };
                applyVisualConfig();
                updateColorPreviews();
            }
        }

                function applyVisualConfig() {
            const root = document.documentElement;
            const appName = visualConfig.app_name || 'Cloudinho';
            const logoUrl = visualConfig.logo_url || '';
            const primaryColor = visualConfig.primary_color || '#667eea';
            const secondaryColor = visualConfig.secondary_color || '#764ba2';
            const sidebarColor = visualConfig.sidebar_color || '#2c3e50';
            
            root.style.setProperty('--primary-color', primaryColor);
            root.style.setProperty('--secondary-color', secondaryColor);
            root.style.setProperty('--sidebar-color', sidebarColor);
            
            const appNameElements = ['appNameLogin', 'appNameChat'];
            appNameElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = appName;
            });
            
            const loginLogo = document.getElementById('loginLogo');
            const sidebarLogo = document.getElementById('sidebarLogo');
            const loginTitle = document.getElementById('loginTitle');
            const sidebarTitle = document.getElementById('sidebarTitle');
            
            if (logoUrl && logoUrl.trim()) {
                if (loginLogo) {
                    loginLogo.src = logoUrl;
                    loginLogo.style.display = 'block';
                    loginLogo.onerror = () => {
                        loginLogo.style.display = 'none';
                        if (loginTitle) loginTitle.style.display = 'block';
                    };
                }
                if (sidebarLogo) {
                    sidebarLogo.src = logoUrl;
                    sidebarLogo.style.display = 'block';
                }
                if (loginTitle) loginTitle.style.display = 'none';
                if (sidebarTitle) sidebarTitle.textContent = appName;
            } else {
                if (loginLogo) loginLogo.style.display = 'none';
                if (sidebarLogo) sidebarLogo.style.display = 'none';
                if (loginTitle) loginTitle.style.display = 'block';
                if (sidebarTitle) sidebarTitle.textContent = 'üîê Prisma';
            }
        }

                function updateColorPreviews() {
            const primaryColor = document.getElementById('primaryColor').value;
            const secondaryColor = document.getElementById('secondaryColor').value;
            const sidebarColor = document.getElementById('sidebarColor').value;
            
            const primaryPreview = document.getElementById('primaryPreview');
            const secondaryPreview = document.getElementById('secondaryPreview');
            const sidebarPreview = document.getElementById('sidebarPreview');
            const primaryValue = document.getElementById('primaryColorValue');
            const secondaryValue = document.getElementById('secondaryColorValue');
            const sidebarValue = document.getElementById('sidebarColorValue');
            
            if (primaryPreview) primaryPreview.style.backgroundColor = primaryColor;
            if (primaryValue) primaryValue.textContent = primaryColor;
            if (secondaryPreview) secondaryPreview.style.backgroundColor = secondaryColor;
            if (secondaryValue) secondaryValue.textContent = secondaryColor;
            if (sidebarPreview) sidebarPreview.style.backgroundColor = sidebarColor;
            if (sidebarValue) sidebarValue.textContent = sidebarColor;
        }

        function updateLogoPreview() {
            const logoUrl = document.getElementById('logoUrl').value;
            const preview = document.getElementById('logoPreview');
            
            if (logoUrl) {
                preview.src = logoUrl;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

                async function saveVisualConfig() {
            const config = {
                app_name: document.getElementById('appName').value || 'Cloudinho',
                logo_url: document.getElementById('logoUrl').value || '',
                primary_color: document.getElementById('primaryColor').value,
                secondary_color: document.getElementById('secondaryColor').value,
                sidebar_color: document.getElementById('sidebarColor').value
            };
            
            try {
                await makeRequest(`${API_URL}/visual-config`, config);
                visualConfig = config;
                applyVisualConfig();
                updateColorPreviews();
                updateLogoPreview();
                
                showSuccess('visualSuccess', 'Configura√ß√µes salvas com sucesso!');
                
            } catch (error) {
                console.error('Failed to save visual config:', error);
                showError('visualError', 'Erro ao salvar configura√ß√µes: ' + error.message);
            }
        }

                function resetVisualConfig() {
            if (confirm('Restaurar configura√ß√µes padr√£o?')) {
                document.getElementById('appName').value = 'Cloudinho';
                document.getElementById('logoUrl').value = '';
                document.getElementById('primaryColor').value = '#667eea';
                document.getElementById('secondaryColor').value = '#764ba2';
                document.getElementById('sidebarColor').value = '#2c3e50';
                updateColorPreviews();
                updateLogoPreview();
                saveVisualConfig();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        window.onload = async function() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const data = await makeRequest(`${API_URL}/verify`, {token});
                    
                    if (data.valid && data.user.role === 'admin') {
                        currentUser = data.user;
                        document.getElementById('currentUser').textContent = data.user.username;
                        document.getElementById('userRole').textContent = data.user.role;
                        document.getElementById('headerUser').textContent = data.user.username;
                        
                        showMainApp();
                    }
                } catch (error) {
                    localStorage.removeItem('token');
                }
            }
            
            loadVisualConfig();
        };

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('primaryColor').addEventListener('input', updateColorPreviews);
            document.getElementById('secondaryColor').addEventListener('input', updateColorPreviews);
            document.getElementById('logoUrl').addEventListener('input', updateLogoPreview);
            document.getElementById('sidebarColor').addEventListener('input', updateColorPreviews);
        });
    </script>
</body>
</html>
